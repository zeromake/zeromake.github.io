---
title: 使用 Redis 做排行榜
date: 2021-04-07T11:51:00Z
tags:
  - redis
  - sort-set
lastmod: 2021-04-07T11:51:00Z
categories:
  - game
slug: redis-rank
draft: true
---

## 前言

## 一、需求

1. 用户打开排行榜及加入该排行榜。
2. 排行榜以排行榜积分和加入排行榜时间来排序。
3. 排行榜满 `100` 就开始分榜，每个分榜单独进行排名。
4. 排行榜有段位晋升掉段，每个段位的晋升掉段比率不同。
5. 每个段位加入后有一些 `buff` 奖励，前多少名有特殊奖励。
6. 排行榜有周期刷新，刷新后根据上一次的名次进行段位变动。

## 二、设计

**排行榜存储**

通过以上的需求，排行榜的访问会是非常频繁的，更新也是不少的，这样的情况直接放数据库的话必然要加缓存，但是要求明显是非常实时，使用数据库加缓存是不行的。
查了一下资料发现很多排行榜的实现依赖于 `Redis` 的 `Sorted Sets`。

`Sorted Sets` 说是 set 但是用起来非常的像一个 `map[string]float64` 不过是默认按 value, key 的方式升序的，也支持倒序。
通过 `ZADD`, `ZREVRANGE` 的 `redis` 命令就可以完成排行榜写入和排行榜读出了。

**排行榜分榜**

先不考虑排行榜周期，也不考虑多个档次的分别要分榜，要求是每个排行榜到达固定人数，就新开一个榜单，这样我在 `redis` 里用一个 `Incr` 数据就解决了。

新加入一个榜单直接对这个榜单人数做 `Incr` 操作，再用 `math.Ceil()` 方法对总榜单人数向上取余，这样就可以根据每个榜单的人数去分榜了。

然后现在再考虑档次和周期的问题，这里我设计为把多个档次的排行榜用户数量组装为一个 `HASH`，然后再把每个 `HASH` 作为一个周期的。

**用户的排行榜数据**

由于 `Sorted Sets` 本身无法存放更多的信息，但是我们也要存放一些例如用户是否加入了榜单，榜单的key，榜单的档次，榜单是否已经过期。

并且还能够存放一些用户的头像昵称的数据，防止这些排行榜必须的数据必须要去数据库重新取，毕竟排行榜的访问必然是非常高频的。


## 三、排行名次存取



## 四、排行榜分榜

## 五、排行同分如何处理

## 六、排行榜的周期切换

## 七、用户的排行榜做归档

## 参考

1. [redis的命令参考](http://www.redis.cn/commands.html#sorted_set)
