{"title":"vue-ssr-koa2","date":"2017-02-19T18:36:25.000Z","tags":["vue","ssr","koa2"],"last_date":"2017-02-19T18:17:25.000Z","filename":"vue-ssr-koa2","body":"<div class=\"toc\"><ul class=\"toc-tree\">\n<li class=\"toc-item toc-level-1\">\n<ul>\n<li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#前言\"><span class=\"toc-number\"></span><span class=\"toc-text\">前言</span></a>\n</li>\n<li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#一.更换依赖包\"><span class=\"toc-number\"></span><span class=\"toc-text\">一.更换依赖包</span></a>\n</li>\n<li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#二.修改 server.js\"><span class=\"toc-number\"></span><span class=\"toc-text\">二.修改 server.js</span></a>\n</li>\n<li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#三.手写一个用于koa2静态文件中间组件 build/serve.js\"><span class=\"toc-number\"></span><span class=\"toc-text\">三.手写一个用于koa2静态文件中间组件 build/serve.js</span></a>\n</li>\n<li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#五.下篇博文预告\"><span class=\"toc-number\"></span><span class=\"toc-text\">五.下篇博文预告</span></a>\n</li>\n<li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#六.源码\"><span class=\"toc-number\"></span><span class=\"toc-text\">六.源码</span></a>\n</li></ul>\n</li></ul></div><h2><a class=\"anchor\" name=\"前言\" href=\"#前言\"><svg aria-hidden=\"true\" class=\"octicon octicon-link\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h2><ul class=\"contains-list\">\n<li class=\"list-item\">在之前的<a href=\"http://blog.zeromake.com/pages/vue-ssr\">vue-ssr</a>中我是使用express来做ssr服务器+api服务器。</li>\n<li class=\"list-item\">但是有些时候可能我希望换一个web框架。</li>\n<li class=\"list-item\">所以就有了这篇闲的慌系类。</li>\n<li class=\"list-item\">vue-ssr中使用koa2来替代express</li>\n</ul>\n<h2><a class=\"anchor\" name=\"一.更换依赖包\" href=\"#一.更换依赖包\"><svg aria-hidden=\"true\" class=\"octicon octicon-link\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>一.更换依赖包</h2><ol class=\"contains-list\">\n<li class=\"list-item\">删掉 express 及它的中间组件 [&#39;compression&#39;, &#39;express&#39;, &#39;serve-favicon&#39;]</li>\n<li class=\"list-item\">添加 koa2 及它的一些中间组件 [&#39;koa2&#39;, &#39;koa-router@7.x&#39;, &#39;koa-send&#39;]</li>\n</ol>\n<h2><a class=\"anchor\" name=\"二.修改 server.js\" href=\"#二.修改 server.js\"><svg aria-hidden=\"true\" class=\"octicon octicon-link\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>二.修改 server.js</h2><ul class=\"contains-list\">\n<li class=\"list-item\"><a href=\"https://github.com/zeromake/my-vue-hackernews/commit/30a6ae819daee46e0fbddafdb61f7b246a11da50\">git修改日志</a></li>\n<li class=\"list-item\"><a href=\"https://github.com/zeromake/my-vue-hackernews/blob/ssr-demo-koa2/server.js\">git地址</a></li>\n<li class=\"list-item\">require: [&#39;./build/serve&#39;]</li>\n</ul>\n<pre class=\"code javascript\"><code class=\"javascript\"><span class=\"hljs-comment\">// [L3-L5] 替换引入的包</span>\n<span class=\"hljs-keyword\">const</span> Koa = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'koa2'</span>)\n<span class=\"hljs-keyword\">const</span> KoaRuoter = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'koa-router'</span>)\n<span class=\"hljs-keyword\">const</span> KoaServe = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'./build/serve'</span>)\n<span class=\"hljs-comment\">// /build/serve.js 这个是我手写的一个静态文件挂载中间组件</span>\n\n<span class=\"hljs-comment\">// [L14-L17] 声明创建app和路由对象</span>\n<span class=\"hljs-keyword\">const</span> app = <span class=\"hljs-keyword\">new</span> Koa()\n<span class=\"hljs-keyword\">const</span> router = <span class=\"hljs-keyword\">new</span> KoaRuoter()\n<span class=\"hljs-comment\">// dev下因为使用原express中间组件，</span>\n<span class=\"hljs-comment\">// 一定要在设置setup-dev-server之前设置api路由。</span>\n<span class=\"hljs-comment\">// 包括普通的静态json文件</span>\n<span class=\"hljs-keyword\">const</span> api_router = <span class=\"hljs-keyword\">new</span> KoaRuoter()\n\n<span class=\"hljs-comment\">// [L20-L44] 更改 serve 函数以便支持koa2，替换原有serve使用的地方</span>\n<span class=\"hljs-keyword\">const</span> serve = <span class=\"hljs-function\">(<span class=\"hljs-params\">url, path, cache</span>) =&gt;</span> KoaServe(url, {\n    root: resolve(path),\n    maxAge: cache &amp;&amp; isProd ? <span class=\"hljs-number\">60</span> * <span class=\"hljs-number\">60</span> * <span class=\"hljs-number\">24</span> * <span class=\"hljs-number\">30</span> : <span class=\"hljs-number\">0</span>\n})\n\n<span class=\"hljs-comment\">// 模拟api</span>\napp.use(serve(<span class=\"hljs-string\">'/api/topstories.json'</span>, <span class=\"hljs-string\">'./public/api/topstories.json'</span>))\napp.use(serve(<span class=\"hljs-string\">'/api/newstories.json'</span>, <span class=\"hljs-string\">'./public/api/newstories.json'</span>))\n<span class=\"hljs-comment\">// 修改为koa支持</span>\napi_router.get(<span class=\"hljs-string\">'/api/item/:id.json'</span>, <span class=\"hljs-function\">(<span class=\"hljs-params\">ctx, next</span>) =&gt;</span> {\n    <span class=\"hljs-keyword\">const</span> id = ctx.params.id\n    <span class=\"hljs-keyword\">const</span> time = <span class=\"hljs-built_in\">parseInt</span>(<span class=\"hljs-built_in\">Math</span>.random()*(<span class=\"hljs-number\">1487396700</span><span class=\"hljs-number\">-1400000000</span>+<span class=\"hljs-number\">1</span>)+<span class=\"hljs-number\">1400000000</span>)\n    <span class=\"hljs-keyword\">const</span> item = {\n        by: <span class=\"hljs-string\">\"zero\"</span> + id,\n        descendants: <span class=\"hljs-number\">0</span>,\n        id: id,\n        score: id - <span class=\"hljs-number\">13664000</span>,\n        time: time,\n        title: <span class=\"hljs-string\">`测试Item:<span class=\"hljs-subst\">${id}</span> - <span class=\"hljs-subst\">${time}</span>`</span>,\n        <span class=\"hljs-keyword\">type</span>: <span class=\"hljs-string\">'story'</span>,\n        url: <span class=\"hljs-string\">`/api/item/<span class=\"hljs-subst\">${id}</span>.json`</span>\n\n    }\n    ctx.body = item\n})\napp.use(api_router.routes()).use(api_router.allowedMethods())\n\n<span class=\"hljs-comment\">// [L89-L132]  ssr的处理转换换为koa2</span>\n<span class=\"hljs-comment\">// 原express 调用res.end会通知express结束,</span>\n<span class=\"hljs-comment\">// koa2则需要使用返回一个Promise来达到异步</span>\nrouter.get(<span class=\"hljs-string\">'*'</span>, <span class=\"hljs-function\">(<span class=\"hljs-params\">ctx, next</span>) =&gt;</span> {\n    <span class=\"hljs-keyword\">if</span> (!renderer) {\n        <span class=\"hljs-keyword\">return</span> ctx.body =<span class=\"hljs-string\">'waiting for compilation.. refresh in a moment.'</span>\n    }\n    ctx.set(<span class=\"hljs-string\">\"Context-Type\"</span>, <span class=\"hljs-string\">\"text/html\"</span>)\n    ctx.set(<span class=\"hljs-string\">\"Server\"</span>, serverInfo)\n    <span class=\"hljs-keyword\">const</span> s = <span class=\"hljs-built_in\">Date</span>.now()\n    <span class=\"hljs-keyword\">const</span> context = { url: ctx.url }\n    <span class=\"hljs-keyword\">const</span> renderStream = renderer.renderToStream(context)\n    <span class=\"hljs-keyword\">const</span> res = ctx.res\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">Promise</span>(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">resolve</span>)</span>{\n        renderStream.once(<span class=\"hljs-string\">'data'</span>, <span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> {\n            <span class=\"hljs-comment\">// 不设置这个会默认404</span>\n            res.statusCode = <span class=\"hljs-number\">200</span>\n            res.write(indexHTML.head)\n        })\n        renderStream.on(<span class=\"hljs-string\">'data'</span>, <span class=\"hljs-function\"><span class=\"hljs-params\">chunk</span> =&gt;</span> {\n            res.write(chunk)\n        })\n        renderStream.on(<span class=\"hljs-string\">'end'</span>, <span class=\"hljs-function\"><span class=\"hljs-params\">()</span> =&gt;</span> {\n            <span class=\"hljs-keyword\">if</span> (context.initialState) {\n                res.write(\n                    <span class=\"hljs-string\">`&lt;script&gt;window.__INSTAL_STATE__=<span class=\"hljs-subst\">${\n                        serialize(context.initialState)\n                    }</span>&lt;/script&gt;`</span>\n                )\n            }\n            res.end(indexHTML.tail)\n            resolve() <span class=\"hljs-comment\">// 通知koa2异步操作已经结束</span>\n            <span class=\"hljs-built_in\">console</span>.log(<span class=\"hljs-string\">`whole request: <span class=\"hljs-subst\">${Date.now() - s}</span>ms`</span>)\n        })\n        renderStream.on(<span class=\"hljs-string\">'error'</span>, <span class=\"hljs-function\"><span class=\"hljs-params\">err</span> =&gt;</span> {\n            <span class=\"hljs-keyword\">if</span> (err &amp;&amp; err.code === <span class=\"hljs-string\">'404'</span>) {\n                res.statusCode = <span class=\"hljs-number\">404</span>\n                res.end(<span class=\"hljs-string\">'404 | Page Not Found'</span>)\n                resolve() <span class=\"hljs-comment\">// 通知koa2异步操作已经结束</span>\n                <span class=\"hljs-keyword\">return</span>\n            }\n            res.statusCode = <span class=\"hljs-number\">500</span>\n            res.end(<span class=\"hljs-string\">'Internal Error 500'</span>)\n            resolve() <span class=\"hljs-comment\">// 通知koa2异步操作已经结束</span>\n            <span class=\"hljs-built_in\">console</span>.error(<span class=\"hljs-string\">`error during render : <span class=\"hljs-subst\">${ctx.url}</span>`</span>)\n            <span class=\"hljs-built_in\">console</span>.error(err)\n        })\n<span class=\"hljs-comment\">// [L134] 注册路由</span>\napp.use(router.routes()).use(router.allowedMethods())\n</code></pre>\n<h2><a class=\"anchor\" name=\"三.手写一个用于koa2静态文件中间组件 build/serve.js\" href=\"#三.手写一个用于koa2静态文件中间组件 build/serve.js\"><svg aria-hidden=\"true\" class=\"octicon octicon-link\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>三.手写一个用于koa2静态文件中间组件 build/serve.js</h2><ul class=\"contains-list\">\n<li class=\"list-item\"><a href=\"https://github.com/zeromake/my-vue-hackernews/blob/ssr-demo-koa2/build/serve.js\">git地址</a></li>\n<li class=\"list-item\"><p>代码不多就都解释下</p>\n<p>``` javascript\n&quot;use strict&quot;\n// 使用 koa-send 模块来发送文件\nconst send = require(&quot;koa-send&quot;);\n// 导出一个参数为url-path + koa-send-opt的函数\nmodule.exports = function serve(path, opt) {\n  // 设置了参数后返回一个标准koa2中间组件方法\n  return function(ctx, next) {</p>\n<pre><code>  const pathUrl = ctx.path\n  <span class=\"hljs-comment\">// 只有匹配了path且请求方法为 get,head 才进行发送文件</span>\n  <span class=\"hljs-keyword\">if</span> ((ctx.method == <span class=\"hljs-string\">\"HEAD\"</span> || ctx.method == <span class=\"hljs-string\">\"GET\"</span>) &amp;&amp; pathUrl.startsWith(path)) {\n      let <span class=\"hljs-keyword\">new</span><span class=\"hljs-type\">Opt</span> = <span class=\"hljs-literal\">null</span>\n      let <span class=\"hljs-keyword\">new</span><span class=\"hljs-type\">Path</span> = <span class=\"hljs-literal\">null</span>\n      <span class=\"hljs-comment\">// 处理 path = pathUrl 且结尾不为/的特殊情况</span>\n      <span class=\"hljs-keyword\">if</span> (pathUrl === path) {\n          <span class=\"hljs-keyword\">if</span> (!path.endsWith(<span class=\"hljs-string\">'/'</span>)) {\n              <span class=\"hljs-comment\">// 去除root路径中的path文件</span>\n              <span class=\"hljs-comment\">// 但为未处理url的文件名与真实文件名不同</span>\n              const <span class=\"hljs-keyword\">new</span><span class=\"hljs-type\">Root</span> = opt.root.slice(<span class=\"hljs-number\">0</span>, -(path.length))\n              <span class=\"hljs-keyword\">new</span><span class=\"hljs-type\">Opt</span> = Object.assign({}, opt, { root: <span class=\"hljs-type\">newRoot </span>})\n              <span class=\"hljs-keyword\">new</span><span class=\"hljs-type\">Path</span> = pathUrl\n          }\n      } <span class=\"hljs-keyword\">else</span> {\n          <span class=\"hljs-comment\">// 去除多余的url</span>\n          <span class=\"hljs-keyword\">new</span><span class=\"hljs-type\">Path</span> = pathUrl.slice(path.length)\n      }\n      <span class=\"hljs-comment\">// 通过 koa-send 发送</span>\n      <span class=\"hljs-keyword\">return</span> send(ctx, <span class=\"hljs-keyword\">new</span><span class=\"hljs-type\">Path</span> || <span class=\"hljs-string\">\"/\"</span>, <span class=\"hljs-keyword\">new</span><span class=\"hljs-type\">Opt</span> || opt)\n  }\n  <span class=\"hljs-keyword\">return</span> next();\n</code></pre><p>  }\n};</p>\n</li>\n</ul>\n<pre><code>\n<span class=\"hljs-section\">## 四.使用现成的npm包来修改build/setup-dev-server.js</span>\n<span class=\"hljs-bullet\">- </span>[<span class=\"hljs-string\">git地址</span>](<span class=\"hljs-link\">https://github.com/zeromake/my-vue-hackernews/blob/ssr-demo-koa2/build/setup-dev-server.js</span>)\n<span class=\"hljs-bullet\">- </span>安装<span class=\"hljs-code\">`npm i koa2-webpack-middleware-zm -D`</span>\n<span class=\"hljs-code\">``` javascript\n// [L6]\nconst { koaDevMiddleware, koaHotMiddleware } = require('koa2-webpack-middleware-zm')\n// [L25]\n    app.use(koaDevMiddleware(devMiddleware))\n// [L39-L40]\n    const expressHotMiddleware = require('webpack-hot-middleware')(clientCompiler)\n    app.use(koaHotMiddleware(expressHotMiddleware))</span>\n</code></pre><ul class=\"contains-list\">\n<li class=\"list-item\">是不是发觉特别简单好吧其实这个npm包是我自己写的</li>\n<li class=\"list-item\">在下一篇博文再介绍吧，这篇博文代码还是太多</li>\n</ul>\n<h2><a class=\"anchor\" name=\"五.下篇博文预告\" href=\"#五.下篇博文预告\"><svg aria-hidden=\"true\" class=\"octicon octicon-link\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>五.下篇博文预告</h2><ol class=\"contains-list\">\n<li class=\"list-item\">修改博文书写方式，尽量放片段代码加图片文字来说明</li>\n<li class=\"list-item\">代码量多的部分使用github的url来引用</li>\n<li class=\"list-item\">下篇博文应该是npm包制作及github集成测试。还有koa的中间组件</li>\n</ol>\n<h2><a class=\"anchor\" name=\"六.源码\" href=\"#六.源码\"><svg aria-hidden=\"true\" class=\"octicon octicon-link\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>六.源码</h2><p><a href=\"https://github.com/zeromake/my-vue-hackernews/tree/ssr-demo-koa2\">源码在这里</a></p>\n"}