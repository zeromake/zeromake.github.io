<!doctype html>
<html lang="zh">
<head>
	
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<link rel="shortcut icon" href="/static/img/zeromake.ico" type="image/x-icon">
	<link rel="icon" sizes="any" href="/static/img/zeromake.svg">
	<meta http-equiv="Content-Language" content="zh">
	<meta name="viewport" content="width=device-width">
	<title>Android6.0权限问题-zeromake static blog</title>
	<link rel="stylesheet" href="/static/css/markdownpad-github.css" type="text/css">
	<link rel="stylesheet" href="/static/css/base.css" type="text/css">
	
	<link rel="stylesheet" href="/css/pygments.css">
	<script type="text/javascript">
		var duoshuoQuery = {short_name:"fly-zero"};
	</script>
	<script src="//static.duoshuo.com/embed.js" charset="utf-8"></script>

	
</head>

<body>
	<div class="base-content">
	<header class="base_header">
		<h1><a href="/">zeromake blog</a></h1>
		<div class="author-info">
			<a class="author-info-github" href="https://github.com/zeromake">GitHub</a>
			<a class="author-info-sf" href="https://segmentfault.com/u/zeromake">SegmentFault</a>
		</div>
	</header>
	<div class="zero_content">
		<div class="markdown-content">
			
	<h1>Android6.0权限问题</h1>
	<div class="markdown-body">
		<div>创建时间: 2015-11-09 09:06:32</div>
		<div>最后更新: </div>
		<div>博客原文:<a href="http://blog.zeromake.com/pages/Android6-0权限问题/">地址</a></div>
		<hr>
		<h2 id="60">6.0权限问题</h2>
<ul>
<li>1.Android6.0的权限与以往不同。
    Android6.0之后引入了新的权限机制，不再是安装时就申请权限，获得后用户不可修改。6.0以后安装时不申请权限，而是运行时申请权限，而且用户可以随时到设置里撤消或允许权限。当然如果程序员不知道这回事就把需要权限的项目的targetSdkVersion的值改为23以下，这样6.0会以原来的方式对待这个软件。如果不改的话，在运行需要权限的代码时会FC，也可以手动到设置里赋予权限但是这个不合适用户使用。
<div class="codehilite"><pre><span></span>    <span class="nt">&lt;uses-sdk</span>
        <span class="na">android:minSdkVersion=</span><span class="s">&quot;8&quot;</span>
        <span class="na">android:targetSdkVersion=</span><span class="s">&quot;23&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</li>
<li>
<p>2.解决方法
还是要在AndroidManifest.xml添加权限
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
用下面的代码获取是否获取到权限。
<div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="n">hasWriteContactsPermission</span> <span class="o">=</span> <span class="n">checkSelfPermission</span><span class="o">(</span><span class="n">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">权限常量</span><span class="o">);</span>
<span class="c1">//获得权限的状态码。如果为PackageManager.PERMISSION_GRANTED就是已获得权限。</span>
</pre></div>

然后用下面代码申请权限
<div class="codehilite"><pre><span></span><span class="kd">final</span> <span class="kt">int</span> <span class="n">REQUEST_CODE_ASK_PERMISSIONS</span> <span class="o">=</span> <span class="mi">123</span><span class="o">;</span>
<span class="c1">//标记数字</span>
<span class="n">requestPermissions</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span><span class="n">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">权限常量</span><span class="o">},</span> 
            <span class="n">REQUEST_CODE_ASK_PERMISSIONS</span><span class="o">);</span>
</pre></div>

试着做了一个单权限申请的方法
<div class="codehilite"><pre><span></span><span class="cm">/**</span>
<span class="cm">* 6.0的权限申请传入权限常量如果获取到了返回true，否则异步申请权限，返回false。</span>
<span class="cm">* @param permissionStr 权限常量字符串</span>
<span class="cm">* @return 如果获取到了返回true，否则异步申请权限，返回false。</span>
<span class="cm">*</span>
<span class="cm">*/</span>
<span class="kd">final</span> <span class="kt">int</span> <span class="n">REQUEST_CODE_ASK_PERMISSIONS</span> <span class="o">=</span> <span class="mi">123</span><span class="o">;</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">insertDummyContactWrapper</span><span class="o">(</span><span class="n">String</span> <span class="n">permissionStr</span><span class="o">)</span> <span class="o">{</span> 
<span class="c1">//标记数字(onRequestPermissionsResult方法中的requestCode)</span>
<span class="kt">int</span> <span class="n">hasWriteContactsPermission</span> <span class="o">=</span> <span class="n">checkSelfPermission</span><span class="o">(</span><span class="n">permissionStr</span><span class="o">);</span>
<span class="c1">//获得权限的状态码。如果为PackageManager.PERMISSION_GRANTED就是已获得权限。</span>
<span class="k">if</span> <span class="o">(</span><span class="n">hasWriteContactsPermission</span> <span class="o">!=</span> <span class="n">PackageManager</span><span class="o">.</span><span class="na">PERMISSION_GRANTED</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//打印吐司提示未获取权限，如果没有弹出申请权限窗口请到设置中允许权限。</span>
    <span class="n">requestPermissions</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span><span class="n">permissionStr</span><span class="o">},</span> 
            <span class="n">REQUEST_CODE_ASK_PERMISSIONS</span><span class="o">);</span> 
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span> 
    <span class="o">}</span> 
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span> 
</pre></div>

不论获取到权限没有都会回调Activity的onRequestPermissionsResult方法。
<div class="codehilite"><pre><span></span><span class="cm">/**</span>
<span class="cm">*</span>
<span class="cm">*@param requestCode 调用requestPermissions时设置的标记数字。</span>
<span class="cm">*@param permissions 请求的权限字符串常量数组。</span>
<span class="cm">*@param grantResults 与permissions数组对应的权限的状态码为PackageManager.PERMISSION_GRANTED就说明申请成功。</span>
<span class="cm">*/</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRequestPermissionsResult</span><span class="o">(</span><span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">permissions</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">grantResults</span><span class="o">){</span>
    <span class="k">if</span><span class="o">(</span><span class="n">requestCode</span><span class="o">==</span><span class="n">REQUEST_CODE_ASK_PERMISSIONS</span><span class="o">){</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">permissions</span><span class="o">.</span><span class="na">length</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">grantResults</span><span class="o">[</span><span class="n">i</span><span class="o">]==</span><span class="n">PackageManager</span><span class="o">.</span><span class="na">PERMISSION_GRANTED</span><span class="o">){</span>
            <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">permissions</span><span class="o">[</span><span class="n">i</span><span class="o">]+</span><span class="s">&quot;获取成功&quot;</span><span class="o">,</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">)</span>
                <span class="o">.</span><span class="na">show</span><span class="o">();</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">permissions</span><span class="o">[</span><span class="n">i</span><span class="o">]+</span><span class="s">&quot;获取失败&quot;</span><span class="o">,</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">)</span>
                <span class="o">.</span><span class="na">show</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="o">}</span><span class="k">else</span><span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onRequestPermissionsResult</span><span class="o">(</span><span class="n">requestCode</span><span class="o">,</span> <span class="n">permissions</span><span class="o">,</span> <span class="n">grantResults</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

    以上的方法checkSelfPermission和requestPermissions都是api23(6.0)后Activity的。如果要兼容需要判断版本。
<div class="codehilite"><pre><span></span><span class="k">if</span> <span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&gt;=</span> <span class="mi">23</span><span class="o">)</span> <span class="o">{</span> 
    <span class="c1">// Marshmallow+ </span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span> 
    <span class="c1">// Pre-Marshmallow </span>
<span class="o">}</span> 
</pre></div>

我建议用v4兼容库，已对这个做过兼容，用这个方法代替：</p>
</li>
<li>
<p>ContextCompat.checkSelfPermission()
被授权函数返回PERMISSION_GRANTED，否则返回PERMISSION_DENIED ，在所有版本都是如此。</p>
</li>
<li>
<p>ActivityCompat.requestPermissions()
这个方法在M之前版本调用，OnRequestPermissionsResultCallback 直接被调用，带着正确的 PERMISSION_GRANTED或者PERMISSION_DENIED 。</p>
</li>
<li>
<p>ActivityCompat.shouldShowRequestPermissionRationale()
在M之前版本调用，永远返回false。在M版时弹出一次申请框后为true。</p>
</li>
</ul>
<p>用v4包的这三方法，完美兼容所有版本！这个方法需要额外的参数，Context or Activity。别的就没啥特别的了。
或是用V13 的FragmentCompat.requestPermissions() FragmentCompat.shouldShowRequestPermissionRationale();
更多更详细的看<a href="http://www.jianshu.com/p/e1ab1a179fbb">Android M 新的运行时权限开发者需要知道的一切</a></p>
		<!-- 多说评论框 start -->
		<div class="ds-thread" data-thread-key="65f3f5a1e8e95fa35213a7cac253a26a" data-title="Android6.0权限问题" data-url="http://blog.zeromake.com/pages/Android6-0权限问题/">
		</div>
	<!-- 多说评论框 end -->
	</div>

		</div>
	</div>
	</div>
</body>
</html>